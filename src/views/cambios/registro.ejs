<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - Amora Inventarios</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <%- include('../partials/navbar') %>

    <main class="container">
        <div class="page-header">
            <h1>üîÑ <%= title %></h1>
            <p>Gestiona cambios de productos en pedidos</p>
            <div class="header-actions">
                <a href="/cambios/lista" class="btn btn-secondary">üìã Ver Lista de Cambios</a>
            </div>
        </div>

        <% if (error) { %>
            <div class="alert alert-danger">
                <%= error %>
            </div>
        <% } %>

        <% if (success) { %>
            <div class="alert alert-success">
                <%= success %>
            </div>
        <% } %>

        <!-- B√∫squeda de pedido -->
        <% if (!locals.pedido) { %>
            <div class="card">
                <div class="form-section">
                    <h3>üîç Buscar Pedido</h3>
                    <p class="text-muted">Primero busca el pedido del cliente por su n√∫mero de WhatsApp</p>
                    
                    <form action="/cambios/buscar-pedido" method="POST" class="form">
                        <!-- Token √∫nico para prevenir duplicados -->
                        <input type="hidden" name="formToken" value="<%= Date.now() + '-' + Math.random().toString(36).substr(2, 9) %>">
                        
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label for="whatsapp">WhatsApp del Cliente *</label>
                                <input 
                                    type="tel" 
                                    id="whatsapp" 
                                    name="whatsapp" 
                                    class="form-control"
                                    placeholder="Ej: 987654321"
                                    pattern="[0-9]{9}"
                                    required
                                >
                                <small>9 d√≠gitos, sin espacios ni guiones</small>
                            </div>
                            <div class="form-group align-end">
                                <button type="submit" class="btn btn-primary">
                                    üîç Buscar Pedido
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        <% } %>

        <!-- Formulario de cambio de talla -->
        <% if (locals.pedidos && pedidos.length > 0) { %>
            <div class="card">
                <div class="pedido-info">
                    <h3>‚úÖ Pedidos Encontrados (<%= pedidos.length %>)</h3>
                    <p class="text-muted">Selecciona el pedido que deseas cambiar. Solo se muestran pedidos en estado "Enviado" o "Entregado".</p>
                </div>
            </div>

            <div class="card">
                <form action="/cambios/registrar" method="POST" class="form">
                    <!-- Token √∫nico para prevenir duplicados -->
                    <input type="hidden" name="formToken" value="<%= Date.now() + '-' + Math.random().toString(36).substr(2, 9) %>">
                    <input type="hidden" name="whatsapp" value="<%= whatsapp %>">
                    
                    <div class="form-section">
                        <h3>üì¶ Selecciona el Pedido a Cambiar</h3>
                        
                        <div class="form-group">
                            <label for="pedidoSeleccionado">Pedido *</label>
                            <select 
                                id="pedidoSeleccionado" 
                                name="pedidoSeleccionado" 
                                class="form-control" 
                                required
                                onchange="cargarDatosPedido()"
                            >
                                <option value="">-- Selecciona un pedido --</option>
                                <% pedidos.forEach((pedido, index) => { %>
                                    <option 
                                        value="<%= index %>"
                                        data-modelo="<%= pedido.modelo %>"
                                        data-talla="<%= pedido.talla %>"
                                        data-cantidad="<%= pedido.cantidad %>"
                                        data-fecha="<%= pedido.fecha %>"
                                        data-estado="<%= pedido.estado %>"
                                    >
                                        <%= pedido.fecha %> - <%= pedido.modelo %> - Talla <%= pedido.talla %> - Cant: <%= pedido.cantidad %> - Estado: <%= pedido.estado %>
                                    </option>
                                <% }) %>
                            </select>
                        </div>

                        <div id="detallesPedido" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px;">
                            <h4>Detalles del Pedido Seleccionado</h4>
                            <div class="info-grid">
                                <div class="info-item">
                                    <strong>Modelo Original:</strong> <span id="detalle-modelo"></span>
                                </div>
                                <div class="info-item">
                                    <strong>Talla Original:</strong> <span id="detalle-talla"></span>
                                </div>
                                <div class="info-item">
                                    <strong>Cantidad:</strong> <span id="detalle-cantidad"></span>
                                </div>
                                <div class="info-item">
                                    <strong>Estado:</strong> <span id="detalle-estado"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section" id="seccionCambio" style="display: none;">
                        <h3>üîÑ Producto Nuevo (para el cambio)</h3>
                        <p class="text-muted">Selecciona el producto que el cliente desea recibir en el cambio</p>
                        
                        <input type="hidden" id="modeloOriginal" name="modeloOriginal">
                        <input type="hidden" id="colorOriginal" name="colorOriginal">
                        <input type="hidden" id="marcaOriginal" name="marcaOriginal">
                        <input type="hidden" id="tacoOriginal" name="tacoOriginal">
                        <input type="hidden" id="tallaSale" name="tallaSale">
                        <input type="hidden" id="cantidadOriginal" name="cantidadOriginal">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fecha">Fecha del Cambio *</label>
                                <input 
                                    type="date" 
                                    id="fecha" 
                                    name="fecha" 
                                    class="form-control"
                                    value="<%= new Date().toISOString().split('T')[0] %>"
                                    required
                                >
                            </div>

                            <div class="form-group" id="grupoCantidadCambio">
                                <label for="cantidadCambio">Cantidad a Cambiar *</label>
                                <input 
                                    type="number" 
                                    id="cantidadCambio" 
                                    name="cantidadCambio" 
                                    class="form-control"
                                    min="1"
                                    value="1"
                                    required
                                >
                                <small>M√°ximo: <span id="maxCantidad">1</span> unidad(es)</small>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="modeloNuevo">Modelo Nuevo *</label>
                            <select 
                                id="modeloNuevo" 
                                name="modeloNuevo" 
                                class="form-control"
                                required
                            >
                                <option value="">Seleccionar modelo</option>
                                <% if (locals.modelos) { %>
                                    <% modelos.forEach(function(modelo) { %>
                                        <option value="<%= modelo %>">
                                            <%= modelo %>
                                        </option>
                                    <% }) %>
                                <% } %>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="colorNuevo">Color Nuevo *</label>
                                <select id="colorNuevo" name="colorNuevo" class="form-control" required>
                                    <option value="">Primero selecciona un modelo</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="marcaNueva">Marca Nueva *</label>
                                <select id="marcaNueva" name="marcaNueva" class="form-control" required>
                                    <option value="">Primero selecciona un modelo</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="tacoNuevo">Tama√±o de Taco Nuevo *</label>
                                <select id="tacoNuevo" name="tacoNuevo" class="form-control" required>
                                    <option value="">Primero selecciona un modelo</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="tallaEntra">Talla Nueva *</label>
                            <select id="tallaEntra" name="tallaEntra" class="form-control" required>
                                <option value="">Selecciona color, marca y taco primero</option>
                            </select>
                            <small id="tallaInfo" class="text-muted">Selecciona los atributos del producto</small>
                        </div>

                        <div class="form-group">
                            <label for="observaciones">Observaciones</label>
                            <textarea 
                                id="observaciones" 
                                name="observaciones" 
                                class="form-control"
                                rows="3"
                                placeholder="Notas adicionales sobre el cambio..."
                            ></textarea>
                        </div>
                    </div>

                    <div class="form-actions" id="botonesAccion" style="display: none;">
                        <button type="submit" class="btn btn-primary">
                            ‚úÖ Registrar Cambio
                        </button>
                        <a href="/cambios/registro" class="btn btn-secondary">
                            ‚ùå Cancelar
                        </a>
                    </div>
                </form>
            </div>

            <script>
                // Datos del pedido en formato JSON para acceso JavaScript
                const pedidosData = <%- JSON.stringify(pedidos || []) %>;
                
                function cargarDatosPedido() {
                    const select = document.getElementById('pedidoSeleccionado');
                    const selectedIndex = parseInt(select.value);
                    
                    if (select.value === '' || isNaN(selectedIndex)) {
                        document.getElementById('detallesPedido').style.display = 'none';
                        document.getElementById('seccionCambio').style.display = 'none';
                        document.getElementById('botonesAccion').style.display = 'none';
                        return;
                    }

                    // Obtener datos del pedido seleccionado
                    const pedido = pedidosData[selectedIndex];
                    if (!pedido) return;

                    // Mostrar detalles
                    document.getElementById('detalle-modelo').textContent = pedido.modelo;
                    document.getElementById('detalle-talla').textContent = pedido.talla;
                    document.getElementById('detalle-cantidad').textContent = pedido.cantidad;
                    document.getElementById('detalle-estado').textContent = pedido.estado;
                    document.getElementById('detallesPedido').style.display = 'block';

                    // Cargar datos en campos ocultos
                    document.getElementById('modeloOriginal').value = pedido.modelo;
                    document.getElementById('tallaSale').value = pedido.talla;
                    document.getElementById('cantidadOriginal').value = pedido.cantidad;

                    // Configurar cantidad a cambiar
                    const inputCantidad = document.getElementById('cantidadCambio');
                    inputCantidad.max = pedido.cantidad;
                    inputCantidad.value = 1;
                    document.getElementById('maxCantidad').textContent = pedido.cantidad;

                    // Mostrar/ocultar grupo de cantidad seg√∫n la cantidad del pedido
                    if (pedido.cantidad > 1) {
                        document.getElementById('grupoCantidadCambio').style.display = 'block';
                    } else {
                        document.getElementById('grupoCantidadCambio').style.display = 'none';
                        inputCantidad.value = 1;
                    }

                    // Mostrar secci√≥n de cambio
                    document.getElementById('seccionCambio').style.display = 'block';
                    document.getElementById('botonesAccion').style.display = 'flex';
                }
            </script>
        <% } %>

        <div class="info-box">
            <h4>üí° Informaci√≥n Importante</h4>
            <ul>
                <li>Solo se muestran pedidos en estado "Enviado" o "Entregado"</li>
                <li>El cambio debe registrarse cuando el cliente devuelve el producto</li>
                <li>Puedes cambiar <strong>cualquier atributo</strong> del producto: modelo, color, marca, taco o talla</li>
                <li>El <strong>producto que sale</strong> es el que el cliente devuelve (se suma al inventario)</li>
                <li>El <strong>producto que entra</strong> es el nuevo que se entrega al cliente (se descuenta del inventario)</li>
                <li>Si el pedido tiene varias unidades, puedes elegir cu√°ntas cambiar</li>
                <li>El estado inicial del cambio es <span class="badge badge-warning">Pendiente</span></li>
                <li>Una vez completado el cambio f√≠sico, actualiza el estado a <span class="badge badge-success">Realizado</span></li>
            </ul>
        </div>
    </main>

    <%- include('../partials/footer') %>

    <script src="/js/main.js"></script>
    
    <% if (locals.inventario) { %>
    <script>
        // Inventario completo desde el servidor
        const inventario = <%- JSON.stringify(inventario || {}) %>;

        const selectModeloNuevo = document.getElementById('modeloNuevo');
        const selectColorNuevo = document.getElementById('colorNuevo');
        const selectMarcaNueva = document.getElementById('marcaNueva');
        const selectTacoNuevo = document.getElementById('tacoNuevo');
        const selectTallaEntra = document.getElementById('tallaEntra');
        const tallaInfo = document.getElementById('tallaInfo');

        // Cuando se selecciona un modelo
        selectModeloNuevo.addEventListener('change', function() {
            const modeloSeleccionado = this.value;
            
            // Limpiar todos los campos dependientes
            selectColorNuevo.innerHTML = '<option value="">Seleccionar color</option>';
            selectMarcaNueva.innerHTML = '<option value="">Seleccionar marca</option>';
            selectTacoNuevo.innerHTML = '<option value="">Seleccionar tama√±o de taco</option>';
            selectTallaEntra.innerHTML = '<option value="">Selecciona color, marca y taco primero</option>';
            tallaInfo.textContent = 'Selecciona color, marca y taco';
            tallaInfo.className = 'text-muted';

            if (modeloSeleccionado && inventario[modeloSeleccionado]) {
                const data = inventario[modeloSeleccionado];
                
                // Poblar colores
                if (data.colores && Array.isArray(data.colores) && data.colores.length > 0) {
                    data.colores.forEach(color => {
                        const option = document.createElement('option');
                        option.value = color;
                        option.textContent = color;
                        selectColorNuevo.appendChild(option);
                    });
                } else {
                    selectColorNuevo.innerHTML = '<option value="">No hay colores disponibles</option>';
                }
                
                // Poblar marcas
                if (data.marcas && Array.isArray(data.marcas) && data.marcas.length > 0) {
                    data.marcas.forEach(marca => {
                        const option = document.createElement('option');
                        option.value = marca;
                        option.textContent = marca;
                        selectMarcaNueva.appendChild(option);
                    });
                } else {
                    selectMarcaNueva.innerHTML = '<option value="">No hay marcas disponibles</option>';
                }
                
                // Poblar tacos
                if (data.tacos && Array.isArray(data.tacos) && data.tacos.length > 0) {
                    data.tacos.forEach(taco => {
                        const option = document.createElement('option');
                        option.value = taco;
                        option.textContent = taco;
                        selectTacoNuevo.appendChild(option);
                    });
                } else {
                    selectTacoNuevo.innerHTML = '<option value="">No hay tacos disponibles</option>';
                }
            }
        });

        // Funci√≥n para actualizar tallas
        function actualizarTallas() {
            const modeloSeleccionado = selectModeloNuevo.value;
            const colorSeleccionado = selectColorNuevo.value;
            const marcaSeleccionada = selectMarcaNueva.value;
            const tacoSeleccionado = selectTacoNuevo.value;
            
            selectTallaEntra.innerHTML = '<option value="">Seleccionar talla</option>';
            tallaInfo.textContent = 'Selecciona color, marca y taco';
            tallaInfo.className = 'text-muted';
            
            // Solo mostrar tallas si los 3 atributos est√°n seleccionados
            if (modeloSeleccionado && colorSeleccionado && marcaSeleccionada && tacoSeleccionado && inventario[modeloSeleccionado]) {
                const varianteKey = `${colorSeleccionado}|${marcaSeleccionada}|${tacoSeleccionado}`;
                const data = inventario[modeloSeleccionado];
                
                // Buscar la variante exacta
                const variante = data.variantes.find(v => v.key === varianteKey);
                
                if (variante && variante.tallas) {
                    const tallasDisponibles = Object.keys(variante.tallas).sort((a, b) => a - b);
                    
                    if (tallasDisponibles.length > 0) {
                        tallasDisponibles.forEach(talla => {
                            const stock = variante.tallas[talla];
                            const option = document.createElement('option');
                            option.value = talla;
                            option.textContent = `${talla} (${stock} disponibles)`;
                            selectTallaEntra.appendChild(option);
                        });
                        
                        tallaInfo.textContent = `üëü Tallas disponibles: ${tallasDisponibles.join(', ')}`;
                        tallaInfo.className = 'text-success';
                    } else {
                        tallaInfo.textContent = '‚ö†Ô∏è Esta combinaci√≥n no tiene stock disponible';
                        tallaInfo.className = 'text-danger';
                    }
                } else {
                    tallaInfo.textContent = '‚ö†Ô∏è Esta combinaci√≥n no est√° disponible en el inventario';
                    tallaInfo.className = 'text-danger';
                }
            }
        }

        // Eventos para actualizar tallas cuando cambian los selectores
        selectColorNuevo.addEventListener('change', actualizarTallas);
        selectMarcaNueva.addEventListener('change', actualizarTallas);
        selectTacoNuevo.addEventListener('change', actualizarTallas);

        // Validar stock antes de enviar
        document.querySelector('form[action="/cambios/registrar"]')?.addEventListener('submit', function(e) {
            const modelo = selectModeloNuevo.value;
            const color = selectColorNuevo.value;
            const marca = selectMarcaNueva.value;
            const taco = selectTacoNuevo.value;
            const talla = parseInt(selectTallaEntra.value);
            const cantidad = parseInt(document.getElementById('cantidadCambio').value);
            
            if (modelo && color && marca && taco && talla && inventario[modelo]) {
                const varianteKey = `${color}|${marca}|${taco}`;
                const data = inventario[modelo];
                const variante = data.variantes.find(v => v.key === varianteKey);
                
                if (variante && variante.tallas) {
                    const stockDisponible = variante.tallas[talla] || 0;
                
                    if (cantidad > stockDisponible) {
                        e.preventDefault();
                        alert(`‚ö†Ô∏è Stock insuficiente.\n\nSolicitado: ${cantidad} unidades\nDisponible: ${stockDisponible} unidades`);
                        return false;
                    }
                }
            }
        });
    </script>
    <% } %>
    
    <script>
        // Validaci√≥n adicional antes de enviar
        document.querySelector('form[action="/cambios/registrar"]')?.addEventListener('submit', function(e) {
            const tallaSale = document.getElementById('tallaSale').value;
            const tallaEntra = document.getElementById('tallaEntra').value;
            const modeloOriginal = document.getElementById('modeloOriginal').value;
            const modeloNuevo = document.getElementById('modeloNuevo').value;
            
            // Solo validar si es el mismo modelo
            if (modeloOriginal === modeloNuevo && tallaSale === tallaEntra) {
                e.preventDefault();
                alert('‚ö†Ô∏è El producto nuevo no puede ser id√©ntico al original.');
                return false;
            }
        });
    </script>
</body>
</html>
