<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - Amora Inventarios</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <%- include('../partials/navbar') %>

    <main class="container">
        <div class="page-header">
            <h1>üîÑ <%= title %></h1>
            <p>Gestiona cambios de talla en pedidos</p>
            <div class="header-actions">
                <a href="/cambios/lista" class="btn btn-secondary">üìã Ver Lista de Cambios</a>
            </div>
        </div>

        <% if (error) { %>
            <div class="alert alert-danger">
                <%= error %>
            </div>
        <% } %>

        <% if (success) { %>
            <div class="alert alert-success">
                <%= success %>
            </div>
        <% } %>

        <!-- B√∫squeda de pedido -->
        <% if (!locals.pedido) { %>
            <div class="card">
                <div class="form-section">
                    <h3>üîç Buscar Pedido</h3>
                    <p class="text-muted">Primero busca el pedido del cliente por su n√∫mero de WhatsApp</p>
                    
                    <form action="/cambios/buscar-pedido" method="POST" class="form">
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label for="whatsapp">WhatsApp del Cliente *</label>
                                <input 
                                    type="tel" 
                                    id="whatsapp" 
                                    name="whatsapp" 
                                    class="form-control"
                                    placeholder="Ej: 987654321"
                                    pattern="[0-9]{9}"
                                    required
                                >
                                <small>9 d√≠gitos, sin espacios ni guiones</small>
                            </div>
                            <div class="form-group align-end">
                                <button type="submit" class="btn btn-primary">
                                    üîç Buscar Pedido
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        <% } %>

        <!-- Formulario de cambio de talla -->
        <% if (locals.pedido) { %>
            <div class="card">
                <div class="pedido-info">
                    <h3>‚úÖ Pedido Encontrado</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <strong>Modelo:</strong> <%= pedido.modelo %>
                        </div>
                        <div class="info-item">
                            <strong>Talla Actual:</strong> <%= pedido.talla %>
                        </div>
                        <div class="info-item">
                            <strong>Cantidad:</strong> <%= pedido.cantidad %>
                        </div>
                        <div class="info-item">
                            <strong>WhatsApp:</strong> <%= pedido.whatsapp %>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <form action="/cambios/registrar" method="POST" class="form">
                    <div class="form-section">
                        <h3>üîÑ Datos del Cambio de Talla</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fecha">Fecha del Cambio *</label>
                                <input 
                                    type="date" 
                                    id="fecha" 
                                    name="fecha" 
                                    class="form-control"
                                    value="<%= new Date().toISOString().split('T')[0] %>"
                                    required
                                >
                            </div>

                            <div class="form-group">
                                <label for="cantidad">Cantidad *</label>
                                <input 
                                    type="number" 
                                    id="cantidad" 
                                    name="cantidad" 
                                    class="form-control"
                                    min="1"
                                    value="<%= pedido.cantidad %>"
                                    required
                                >
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="modelo">Modelo *</label>
                            <input 
                                type="text" 
                                id="modelo" 
                                name="modelo" 
                                class="form-control"
                                value="<%= pedido.modelo %>"
                                readonly
                            >
                        </div>

                        <div class="cambio-tallas-container">
                            <div class="talla-box talla-sale">
                                <label for="tallaSale">Talla que SALE *</label>
                                <select id="tallaSale" name="tallaSale" class="form-control form-control-lg" required>
                                    <% for(let t = 35; t <= 40; t++) { %>
                                        <option value="<%= t %>" <%= t == pedido.talla ? 'selected' : '' %>>
                                            <%= t %>
                                        </option>
                                    <% } %>
                                </select>
                                <small>Talla que el cliente devuelve</small>
                            </div>

                            <div class="arrow-container">
                                <span class="arrow">‚û°Ô∏è</span>
                            </div>

                            <div class="talla-box talla-entra">
                                <label for="tallaEntra">Talla que ENTRA *</label>
                                <select id="tallaEntra" name="tallaEntra" class="form-control form-control-lg" required>
                                    <option value="">Seleccionar talla</option>
                                    <% if (locals.tallasDisponibles && tallasDisponibles.length > 0) { %>
                                        <% tallasDisponibles.forEach(item => { %>
                                            <option value="<%= item.talla %>">
                                                <%= item.talla %> (<%= item.stock %> disponibles)
                                            </option>
                                        <% }) %>
                                    <% } else { %>
                                        <% for(let t = 35; t <= 40; t++) { %>
                                            <option value="<%= t %>" disabled>
                                                <%= t %> (sin stock)
                                            </option>
                                        <% } %>
                                    <% } %>
                                </select>
                                <small>Talla nueva que se entrega</small>
                            </div>
                        </div>

                        <input type="hidden" name="whatsapp" value="<%= pedido.whatsapp %>">
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            ‚úì Registrar Cambio de Talla
                        </button>
                        <a href="/cambios/registro" class="btn btn-secondary">
                            üîç Buscar Otro Pedido
                        </a>
                    </div>
                </form>
            </div>
        <% } %>

        <div class="info-box">
            <h4>üí° Informaci√≥n Importante</h4>
            <ul>
                <li>El cambio de talla debe registrarse cuando el cliente devuelve el producto</li>
                <li>La <strong>talla que sale</strong> es la que el cliente devuelve (se suma al inventario)</li>
                <li>La <strong>talla que entra</strong> es la nueva que se entrega al cliente (se descuenta del inventario)</li>
                <li>El estado inicial del cambio es <span class="badge badge-warning">Pendiente</span></li>
                <li>Una vez completado el cambio f√≠sico, actualiza el estado a <span class="badge badge-success">Realizado</span></li>
            </ul>
        </div>
    </main>

    <%- include('../partials/footer') %>

    <script src="/js/main.js"></script>
    <script>
        // Validar que las tallas no sean iguales
        document.querySelector('form[action="/cambios/registrar"]')?.addEventListener('submit', function(e) {
            const tallaSale = document.getElementById('tallaSale').value;
            const tallaEntra = document.getElementById('tallaEntra').value;
            
            if (tallaSale === tallaEntra) {
                e.preventDefault();
                alert('‚ö†Ô∏è La talla que sale y la que entra no pueden ser la misma.');
                return false;
            }
        });
    </script>
</body>
</html>
