<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - Amora Inventarios</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <%- include('../partials/navbar') %>

    <main class="container">
        <div class="page-header">
            <h1>üîÑ <%= title %></h1>
            <p>Gestiona cambios de talla en pedidos</p>
            <div class="header-actions">
                <a href="/cambios/lista" class="btn btn-secondary">üìã Ver Lista de Cambios</a>
            </div>
        </div>

        <% if (error) { %>
            <div class="alert alert-danger">
                <%= error %>
            </div>
        <% } %>

        <% if (success) { %>
            <div class="alert alert-success">
                <%= success %>
            </div>
        <% } %>

        <!-- B√∫squeda de pedido -->
        <% if (!locals.pedido) { %>
            <div class="card">
                <div class="form-section">
                    <h3>üîç Buscar Pedido</h3>
                    <p class="text-muted">Primero busca el pedido del cliente por su n√∫mero de WhatsApp</p>
                    
                    <form action="/cambios/buscar-pedido" method="POST" class="form">
                        <!-- Token √∫nico para prevenir duplicados -->
                        <input type="hidden" name="formToken" value="<%= Date.now() + '-' + Math.random().toString(36).substr(2, 9) %>">
                        
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label for="whatsapp">WhatsApp del Cliente *</label>
                                <input 
                                    type="tel" 
                                    id="whatsapp" 
                                    name="whatsapp" 
                                    class="form-control"
                                    placeholder="Ej: 987654321"
                                    pattern="[0-9]{9}"
                                    required
                                >
                                <small>9 d√≠gitos, sin espacios ni guiones</small>
                            </div>
                            <div class="form-group align-end">
                                <button type="submit" class="btn btn-primary">
                                    üîç Buscar Pedido
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        <% } %>

        <!-- Formulario de cambio de talla -->
        <% if (locals.pedidos && pedidos.length > 0) { %>
            <div class="card">
                <div class="pedido-info">
                    <h3>‚úÖ Pedidos Encontrados (<%= pedidos.length %>)</h3>
                    <p class="text-muted">Selecciona el pedido que deseas cambiar. Solo se muestran pedidos en estado "Enviado" o "Entregado".</p>
                </div>
            </div>

            <div class="card">
                <form action="/cambios/registrar" method="POST" class="form">
                    <!-- Token √∫nico para prevenir duplicados -->
                    <input type="hidden" name="formToken" value="<%= Date.now() + '-' + Math.random().toString(36).substr(2, 9) %>">
                    <input type="hidden" name="whatsapp" value="<%= whatsapp %>">
                    
                    <div class="form-section">
                        <h3>üì¶ Selecciona el Pedido a Cambiar</h3>
                        
                        <div class="form-group">
                            <label for="pedidoSeleccionado">Pedido *</label>
                            <select 
                                id="pedidoSeleccionado" 
                                name="pedidoSeleccionado" 
                                class="form-control" 
                                required
                                onchange="cargarDatosPedido()"
                            >
                                <option value="">-- Selecciona un pedido --</option>
                                <% pedidos.forEach((pedido, index) => { %>
                                    <option 
                                        value="<%= index %>"
                                        data-modelo="<%= pedido.modelo %>"
                                        data-talla="<%= pedido.talla %>"
                                        data-cantidad="<%= pedido.cantidad %>"
                                        data-fecha="<%= pedido.fecha %>"
                                        data-estado="<%= pedido.estado %>"
                                    >
                                        <%= pedido.fecha %> - <%= pedido.modelo %> - Talla <%= pedido.talla %> - Cant: <%= pedido.cantidad %> - Estado: <%= pedido.estado %>
                                    </option>
                                <% }) %>
                            </select>
                        </div>

                        <div id="detallesPedido" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px;">
                            <h4>Detalles del Pedido Seleccionado</h4>
                            <div class="info-grid">
                                <div class="info-item">
                                    <strong>Modelo Original:</strong> <span id="detalle-modelo"></span>
                                </div>
                                <div class="info-item">
                                    <strong>Talla Original:</strong> <span id="detalle-talla"></span>
                                </div>
                                <div class="info-item">
                                    <strong>Cantidad:</strong> <span id="detalle-cantidad"></span>
                                </div>
                                <div class="info-item">
                                    <strong>Estado:</strong> <span id="detalle-estado"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section" id="seccionCambio" style="display: none;">
                        <h3>üîÑ Datos del Cambio</h3>
                        
                        <input type="hidden" id="modeloOriginal" name="modeloOriginal">
                        <input type="hidden" id="tallaSale" name="tallaSale">
                        <input type="hidden" id="cantidadOriginal" name="cantidadOriginal">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fecha">Fecha del Cambio *</label>
                                <input 
                                    type="date" 
                                    id="fecha" 
                                    name="fecha" 
                                    class="form-control"
                                    value="<%= new Date().toISOString().split('T')[0] %>"
                                    required
                                >
                            </div>

                            <div class="form-group" id="grupoCantidadCambio">
                                <label for="cantidadCambio">Cantidad a Cambiar *</label>
                                <input 
                                    type="number" 
                                    id="cantidadCambio" 
                                    name="cantidadCambio" 
                                    class="form-control"
                                    min="1"
                                    value="1"
                                    required
                                >
                                <small>M√°ximo: <span id="maxCantidad">1</span> unidad(es)</small>
                            </div>
                        </div>

                        <div class="form-row">
                            <% if (locals.tieneMultiplesModelos) { %>
                                <div class="form-group">
                                    <label for="modeloNuevo">Modelo Nuevo (opcional)</label>
                                    <input 
                                        type="text" 
                                        id="modeloNuevo" 
                                        name="modeloNuevo" 
                                        class="form-control"
                                        placeholder="Dejar vac√≠o si solo cambia talla"
                                    >
                                    <small>Solo si el cliente quiere cambiar de modelo</small>
                                </div>
                            <% } else { %>
                                <input type="hidden" id="modeloNuevo" name="modeloNuevo" value="">
                            <% } %>

                            <div class="form-group">
                                <label for="tallaEntra">Nueva Talla *</label>
                                <select 
                                    id="tallaEntra" 
                                    name="tallaEntra" 
                                    class="form-control" 
                                    required
                                >
                                    <option value="">-- Selecciona talla --</option>
                                    <% for(let t = 35; t <= 40; t++) { %>
                                        <option value="<%= t %>"><%= t %></option>
                                    <% } %>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="observaciones">Observaciones</label>
                            <textarea 
                                id="observaciones" 
                                name="observaciones" 
                                class="form-control"
                                rows="3"
                                placeholder="Notas adicionales sobre el cambio..."
                            ></textarea>
                        </div>
                    </div>

                    <div class="form-actions" id="botonesAccion" style="display: none;">
                        <button type="submit" class="btn btn-primary">
                            ‚úÖ Registrar Cambio
                        </button>
                        <a href="/cambios/registro" class="btn btn-secondary">
                            ‚ùå Cancelar
                        </a>
                    </div>
                </form>
            </div>

            <script>
                function cargarDatosPedido() {
                    const select = document.getElementById('pedidoSeleccionado');
                    const selectedOption = select.options[select.selectedIndex];
                    
                    if (selectedOption.value === '') {
                        document.getElementById('detallesPedido').style.display = 'none';
                        document.getElementById('seccionCambio').style.display = 'none';
                        document.getElementById('botonesAccion').style.display = 'none';
                        return;
                    }

                    // Mostrar detalles
                    const modelo = selectedOption.dataset.modelo;
                    const talla = selectedOption.dataset.talla;
                    const cantidad = parseInt(selectedOption.dataset.cantidad);
                    const estado = selectedOption.dataset.estado;

                    document.getElementById('detalle-modelo').textContent = modelo;
                    document.getElementById('detalle-talla').textContent = talla;
                    document.getElementById('detalle-cantidad').textContent = cantidad;
                    document.getElementById('detalle-estado').textContent = estado;
                    document.getElementById('detallesPedido').style.display = 'block';

                    // Cargar datos en campos ocultos
                    document.getElementById('modeloOriginal').value = modelo;
                    document.getElementById('tallaSale').value = talla;
                    document.getElementById('cantidadOriginal').value = cantidad;

                    // Configurar cantidad a cambiar
                    const inputCantidad = document.getElementById('cantidadCambio');
                    inputCantidad.max = cantidad;
                    inputCantidad.value = 1;
                    document.getElementById('maxCantidad').textContent = cantidad;

                    // Mostrar/ocultar grupo de cantidad seg√∫n la cantidad del pedido
                    if (cantidad > 1) {
                        document.getElementById('grupoCantidadCambio').style.display = 'block';
                    } else {
                        document.getElementById('grupoCantidadCambio').style.display = 'none';
                        inputCantidad.value = 1;
                    }

                    // Mostrar secci√≥n de cambio
                    document.getElementById('seccionCambio').style.display = 'block';
                    document.getElementById('botonesAccion').style.display = 'flex';
                }
            </script>
        <% } %>

        <div class="info-box">
            <h4>üí° Informaci√≥n Importante</h4>
            <ul>
                <li>Solo se muestran pedidos en estado "Enviado" o "Entregado"</li>
                <li>El cambio de talla debe registrarse cuando el cliente devuelve el producto</li>
                <li>La <strong>talla que sale</strong> es la que el cliente devuelve (se suma al inventario)</li>
                <li>La <strong>talla que entra</strong> es la nueva que se entrega al cliente (se descuenta del inventario)</li>
                <li>Si el pedido tiene varias unidades, puedes elegir cu√°ntas cambiar</li>
                <li>El campo de modelo solo aparece si el cliente ha comprado diferentes modelos</li>
                <li>El estado inicial del cambio es <span class="badge badge-warning">Pendiente</span></li>
                <li>Una vez completado el cambio f√≠sico, actualiza el estado a <span class="badge badge-success">Realizado</span></li>
            </ul>
        </div>
    </main>

    <%- include('../partials/footer') %>

    <script src="/js/main.js"></script>
    <script>
        // Validar que las tallas no sean iguales
        document.querySelector('form[action="/cambios/registrar"]')?.addEventListener('submit', function(e) {
            const tallaSale = document.getElementById('tallaSale').value;
            const tallaEntra = document.getElementById('tallaEntra').value;
            
            if (tallaSale === tallaEntra) {
                e.preventDefault();
                alert('‚ö†Ô∏è La talla que sale y la que entra no pueden ser la misma.');
                return false;
            }
        });
    </script>
</body>
</html>
