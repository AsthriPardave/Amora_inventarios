<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - Amora Inventarios</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <%- include('../partials/navbar') %>

    <main class="container">
        <div class="page-header">
            <h1>üì¶ <%= title %></h1>
            <div class="header-actions">
                <a href="/productos/registrar" class="btn btn-primary">+ Agregar nuevo producto</a>
            </div>
        </div>

        <!-- Filtros de b√∫squeda -->
        <div class="card">
            <div class="search-filters">
                <h3>üîç Filtros de B√∫squeda</h3>
                <form id="formFiltros" class="filters-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="buscarModelo">Buscar Modelo</label>
                            <input 
                                type="text" 
                                id="buscarModelo" 
                                class="form-control"
                                placeholder="Buscar por nombre o c√≥digo..."
                            >
                        </div>
                        
                        <div class="form-group">
                            <label for="filtroMarca">Marca</label>
                            <input 
                                type="text" 
                                id="filtroMarca" 
                                class="form-control"
                                placeholder="Filtrar por marca..."
                            >
                        </div>

                        <div class="form-group">
                            <label for="filtroColor">Color</label>
                            <input 
                                type="text" 
                                id="filtroColor" 
                                class="form-control"
                                placeholder="Filtrar por color..."
                            >
                        </div>
                        
                        <div class="form-group">
                            <label for="filtroTalla">Talla</label>
                            <select id="filtroTalla" class="form-control">
                                <option value="">Todas las tallas</option>
                                <% for(let t = 35; t <= 40; t++) { %>
                                    <option value="<%= t %>"><%= t %></option>
                                <% } %>
                            </select>
                        </div>

                        <div class="form-group align-end">
                            <button type="button" class="btn btn-primary" onclick="aplicarFiltros()">
                                üîç Buscar
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="limpiarFiltros()">
                                ‚úï Limpiar
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabla de inventario -->
        <div class="card">
            <div class="inventory-grid">
                <% if (productos && productos.length > 0) { %>
                    <div class="table-responsive">
                        <table class="table" id="tablaInventario">
                        <thead>
                            <tr>
                                <th rowspan="2">Modelo</th>
                                <th rowspan="2">Marca</th>
                                <th rowspan="2">Color</th>
                                <th rowspan="2">Taco</th>
                                <th colspan="6">Tallas</th>
                                <th rowspan="2">Total</th>
                                <th rowspan="2">Precio</th>
                                <th rowspan="2">Estado</th>
                            </tr>
                            <tr>
                                <th>35</th>
                                <th>36</th>
                                <th>37</th>
                                <th>38</th>
                                <th>39</th>
                                <th>40</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% productos.forEach(producto => { %>
                                <tr data-modelo="<%= producto.modelo.toLowerCase() %>" 
                                    data-marca="<%= (producto.marca || '').toLowerCase() %>"
                                    data-color="<%= (producto.color || '').toLowerCase() %>">
                                    <td><strong><%= producto.modelo %></strong></td>
                                    <td><%= producto.marca || '-' %></td>
                                    <td><%= producto.color || '-' %></td>
                                    <td><%= producto.tamano_taco || '-' %></td>
                                    <td class="<%= producto.talla_35 === 0 ? 'stock-cero' : producto.talla_35 < 3 ? 'stock-bajo' : '' %>">
                                        <%= producto.talla_35 %>
                                    </td>
                                    <td class="<%= producto.talla_36 === 0 ? 'stock-cero' : producto.talla_36 < 3 ? 'stock-bajo' : '' %>">
                                        <%= producto.talla_36 %>
                                    </td>
                                    <td class="<%= producto.talla_37 === 0 ? 'stock-cero' : producto.talla_37 < 3 ? 'stock-bajo' : '' %>">
                                        <%= producto.talla_37 %>
                                    </td>
                                    <td class="<%= producto.talla_38 === 0 ? 'stock-cero' : producto.talla_38 < 3 ? 'stock-bajo' : '' %>">
                                        <%= producto.talla_38 %>
                                    </td>
                                    <td class="<%= producto.talla_39 === 0 ? 'stock-cero' : producto.talla_39 < 3 ? 'stock-bajo' : '' %>">
                                        <%= producto.talla_39 %>
                                    </td>
                                    <td class="<%= producto.talla_40 === 0 ? 'stock-cero' : producto.talla_40 < 3 ? 'stock-bajo' : '' %>">
                                        <%= producto.talla_40 %>
                                    </td>
                                    <td><strong><%= producto.total %></strong></td>
                                    <td><%= producto.precio || '-' %></td>
                                    <td>
                                        <% if (producto.total === 0) { %>
                                            <span class="badge badge-danger">Sin stock</span>
                                        <% } else if (producto.total < 10) { %>
                                            <span class="badge badge-warning">Stock bajo</span>
                                        <% } else { %>
                                            <span class="badge badge-success">Disponible</span>
                                        <% } %>
                                    </td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                    </div>
                <% } else { %>
                    <div class="empty-state">
                        <div class="empty-icon">üì¶</div>
                        <h3>No hay productos en el inventario</h3>
                        <p>Comienza registrando el ingreso de productos</p>
                        <a href="/ingresos/registrar" class="btn btn-primary">Registrar primer ingreso</a>
                    </div>
                <% } %>
            </div>
        </div>

        <div class="info-box">
            <h4>üí° Informaci√≥n</h4>
            <ul>
                <li><strong>Stock bajo:</strong> Tallas con menos de 3 unidades aparecen en amarillo</li>
                <li><strong>Sin stock:</strong> Tallas sin unidades aparecen en rojo</li>
                <li>Usa los filtros para encontrar productos espec√≠ficos r√°pidamente</li>
                <li>Las estad√≠sticas se actualizan autom√°ticamente</li>
            </ul>
        </div>
    </main>

    <%- include('../partials/footer') %>

    <script src="/js/main.js"></script>
    <script src="/js/inventario.js"></script>
    <script>
        // Funcionalidad de filtros
        function aplicarFiltros() {
            const buscarModelo = document.getElementById('buscarModelo').value.toLowerCase();
            const filtroMarca = document.getElementById('filtroMarca').value.toLowerCase();
            const filtroColor = document.getElementById('filtroColor').value.toLowerCase();
            const filtroTalla = document.getElementById('filtroTalla').value;
            
            const filas = document.querySelectorAll('#tablaInventario tbody tr');
            let visibles = 0;
            
            filas.forEach(fila => {
                let mostrar = true;
                
                // Filtro por modelo
                if (buscarModelo) {
                    const modelo = fila.getAttribute('data-modelo') || '';
                    if (!modelo.includes(buscarModelo)) {
                        mostrar = false;
                    }
                }
                
                // Filtro por marca
                if (filtroMarca && mostrar) {
                    const marca = fila.getAttribute('data-marca') || '';
                    if (!marca.includes(filtroMarca)) {
                        mostrar = false;
                    }
                }
                
                // Filtro por color
                if (filtroColor && mostrar) {
                    const color = fila.getAttribute('data-color') || '';
                    if (!color.includes(filtroColor)) {
                        mostrar = false;
                    }
                }
                
                // Filtro por talla
                if (filtroTalla && mostrar) {
                    const celdas = fila.getElementsByTagName('td');
                    // √çndice ajustado: modelo(0), marca(1), color(2), taco(3), T35(4)...
                    const indiceTalla = parseInt(filtroTalla) - 35 + 4;
                    const stockTalla = parseInt(celdas[indiceTalla]?.textContent || '0');
                    if (stockTalla === 0) {
                        mostrar = false;
                    }
                }
                
                fila.style.display = mostrar ? '' : 'none';
                if (mostrar) visibles++;
            });
            
            // Mostrar mensaje si no hay resultados
            if (visibles === 0 && filas.length > 0) {
                alert('No se encontraron productos con los filtros seleccionados');
            }
        }

        function limpiarFiltros() {
            document.getElementById('buscarModelo').value = '';
            document.getElementById('filtroMarca').value = '';
            document.getElementById('filtroColor').value = '';
            document.getElementById('filtroTalla').value = '';
            
            // Mostrar todas las filas
            const filas = document.querySelectorAll('#tablaInventario tbody tr');
            filas.forEach(fila => {
                fila.style.display = '';
            });
        }
    </script>
</body>
</html>
