<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - Amora Inventarios</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <%- include('../partials/navbar') %>

    <main class="container">
        <div class="page-header">
            <h1>üõí Registrar Venta</h1>
            <p>Registra una nueva venta y actualiza el inventario</p>
        </div>

        <% if (error) { %>
            <div class="alert alert-danger">
                <%= error %>
            </div>
        <% } %>

        <% if (success) { %>
            <div class="alert alert-success">
                <%= success %>
            </div>
        <% } %>

        <div class="card">
            <form action="/ventas/registrar" method="POST" class="form" id="formVenta">
                <!-- Token √∫nico para prevenir duplicados -->
                <input type="hidden" name="formToken" value="<%= Date.now() + '-' + Math.random().toString(36).substr(2, 9) %>">
                
                <div class="form-section">
                    <h3>ÔøΩ Informaci√≥n de Venta</h3>
                    
                    <div class="form-group">
                        <label for="fecha">Fecha</label>
                        <input 
                            type="text" 
                            id="fecha" 
                            name="fecha" 
                            class="form-control"
                            value="<%= new Date().toLocaleDateString('es-PE', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) %>"
                            readonly
                            style="background-color: #f5f7fa;"
                        >
                        <small>Fecha autom√°tica de registro</small>
                    </div>

                    <div class="form-group">
                        <label for="modelo">Modelo *</label>
                        <select 
                            id="modelo" 
                            name="modelo" 
                            class="form-control"
                            required
                        >
                            <option value="">Seleccionar modelo</option>
                            <% modelos.forEach(function(modelo) { %>
                                <option value="<%= modelo %>" <%= locals.formData?.modelo === modelo ? 'selected' : '' %>>
                                    <%= modelo %>
                                </option>
                            <% }) %>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="color">Color *</label>
                            <select id="color" name="color" class="form-control" required disabled>
                                <option value="">Primero selecciona un modelo</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="marca">Marca *</label>
                            <select id="marca" name="marca" class="form-control" required disabled>
                                <option value="">Primero selecciona un modelo</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="tamano_taco">Tama√±o de Taco *</label>
                            <select id="tamano_taco" name="tamano_taco" class="form-control" required disabled>
                                <option value="">Primero selecciona un modelo</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="talla">Talla *</label>
                            <select id="talla" name="talla" class="form-control" required disabled>
                                <option value="">Selecciona color, marca y taco primero</option>
                            </select>
                            <small id="tallaInfo" class="text-muted">Selecciona los atributos del producto</small>
                        </div>

                        <div class="form-group">
                            <label for="cantidad">Cantidad *</label>
                            <input 
                                type="number" 
                                id="cantidad" 
                                name="cantidad" 
                                class="form-control"
                                min="1"
                                value="<%= locals.formData?.cantidad || 1 %>"
                                required
                            >
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>üìç Direcci√≥n de Env√≠o</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="departamento">Departamento *</label>
                            <select id="departamento" name="departamento" class="form-control" required>
                                <option value="">Seleccionar</option>
                                <% Object.keys(ubigeo).sort().forEach(function(departamento) { %>
                                    <option value="<%= departamento %>" <%= locals.formData?.departamento === departamento ? 'selected' : '' %>>
                                        <%= departamento %>
                                    </option>
                                <% }) %>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="provincia">Provincia *</label>
                            <select id="provincia" name="provincia" class="form-control" required disabled>
                                <option value="">Seleccionar</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="distrito">Distrito *</label>
                            <select id="distrito" name="distrito" class="form-control" required disabled>
                                <option value="">Seleccionar</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="direccion">Direcci√≥n *</label>
                        <input 
                            type="text" 
                            id="direccion" 
                            name="direccion" 
                            class="form-control"
                            placeholder="Ej: Av. Los Pinos 456 Int. 301"
                            value="<%= locals.formData?.direccion || '' %>"
                            required
                        >
                        <small>Direcci√≥n completa: calle, n√∫mero, interior, etc.</small>
                    </div>

                    <div class="form-group">
                        <label for="referencia">Referencias</label>
                        <input 
                            type="text" 
                            id="referencia" 
                            name="referencia" 
                            class="form-control"
                            placeholder="Ej: Frente al parque, al costado de la farmacia"
                            value="<%= locals.formData?.referencia || '' %>"
                        >
                        <small>Puntos de referencia para facilitar la entrega</small>
                    </div>
                </div>

                <div class="form-section">
                    <h3>üì± Datos del Cliente y Estado</h3>
                    
                    <div class="form-group">
                        <label for="whatsapp">WhatsApp *</label>
                        <input 
                            type="tel" 
                            id="whatsapp" 
                            name="whatsapp" 
                            class="form-control"
                            placeholder="Ej: 987654321"
                            pattern="[0-9]{9}"
                            value="<%= locals.formData?.whatsapp || '' %>"
                            required
                        >
                        <small>9 d√≠gitos, sin espacios ni guiones</small>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input 
                                type="checkbox" 
                                id="deliveryPagado" 
                                name="deliveryPagado" 
                                value="true"
                                checked
                                disabled
                            >
                            <span class="checkbox-text">‚úì Delivery Pagado (Obligatorio)</span>
                        </label>
                        <input type="hidden" name="deliveryPagado" value="true">
                        <small class="text-info">‚ÑπÔ∏è El delivery debe estar pagado para registrar la venta</small>
                    </div>

                    <div class="form-group">
                        <label for="estado">Estado</label>
                        <input 
                            type="text" 
                            id="estado" 
                            class="form-control"
                            value="Pendiente de env√≠o"
                            readonly
                            style="background-color: #f5f7fa;"
                        >
                        <small>Estado autom√°tico al registrar</small>
                    </div>

                    <div class="form-group">
                        <label for="observaciones">Observaciones</label>
                        <textarea 
                            id="observaciones" 
                            name="observaciones" 
                            class="form-control"
                            rows="3"
                            placeholder="Cualquier detalle adicional sobre esta venta"
                        ><%= locals.formData?.observaciones || '' %></textarea>
                    </div>

                    <!-- Mensajes de confirmaci√≥n para copiar -->
                    <div class="form-group" style="margin-top: 1.5rem;">
                        <label>üí¨ Mensajes de Confirmaci√≥n (clic para copiar)</label>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <button type="button" class="btn btn-secondary" onclick="copiarMensaje('lima')" style="text-align: left; font-size: 0.9rem; padding: 0.5rem;">
                                üáµüá™ Lima: "Pedido confirmado con pago de delivery S/10. El pago total se realiza al momento de la entrega."
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="copiarMensaje('provincia')" style="text-align: left; font-size: 0.9rem; padding: 0.5rem;">
                                üöö Provincia: "Pedido confirmado. Env√≠o tras validaci√≥n del pago correspondiente."
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="copiarMensaje('cambio')" style="text-align: left; font-size: 0.9rem; padding: 0.5rem;">
                                üîÑ Cambio: "Enviar video detallado del calzado para evaluaci√≥n."
                            </button>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        ‚úì Registrar Venta
                    </button>
                    <a href="/" class="btn btn-secondary">
                        ‚úï Cancelar
                    </a>
                </div>
            </form>
        </div>

        <div class="info-box info-box-warning">
            <h4>‚ö†Ô∏è Reglas Importantes</h4>
            <ul>
                <li><strong>El delivery DEBE estar pagado</strong> para registrar la venta</li>
                <li>Si el delivery no est√° pagado, la venta no se registrar√°</li>
                <li>El stock solo se descuenta cuando el delivery est√° confirmado como pagado</li>
                <li>Verifica la disponibilidad del producto antes de confirmar la venta</li>
            </ul>
        </div>

        <div class="info-box">
            <h4>üì¶ Ejemplo de Direcci√≥n Completa</h4>
            <ul>
                <li><strong>Departamento:</strong> Lima</li>
                <li><strong>Provincia:</strong> Lima</li>
                <li><strong>Distrito:</strong> San Isidro</li>
                <li><strong>Direcci√≥n:</strong> Av. Los Rosales 456 Int. Dpto 301</li>
                <li><strong>Referencia:</strong> Frente al parque principal (opcional)</li>
                <li><strong>Resultado final:</strong> Av. Los Rosales 456 Int. Dpto 301, San Isidro, Lima, Lima</li>
            </ul>
        </div>
    </main>

    <%- include('../partials/footer') %>

    <script src="/js/main.js"></script>
    <script>
        // Datos de ubigeo desde el servidor
        const ubigeoData = <%- JSON.stringify(ubigeo || {}) %>;

        // Referencias a los selectores
        const selectDepartamento = document.getElementById('departamento');
        const selectProvincia = document.getElementById('provincia');
        const selectDistrito = document.getElementById('distrito');

        // Evento cuando se selecciona un departamento
        selectDepartamento.addEventListener('change', function() {
            const departamento = this.value;
            
            // Limpiar y deshabilitar provincia y distrito
            selectProvincia.innerHTML = '<option value="">Seleccionar provincia</option>';
            selectDistrito.innerHTML = '<option value="">Primero selecciona una provincia</option>';
            selectDistrito.disabled = true;
            
            if (departamento && ubigeoData[departamento]) {
                const provincias = Object.keys(ubigeoData[departamento]).sort();
                
                provincias.forEach(function(provincia) {
                    const option = document.createElement('option');
                    option.value = provincia;
                    option.textContent = provincia;
                    selectProvincia.appendChild(option);
                });
                
                selectProvincia.disabled = false;
            } else {
                selectProvincia.disabled = true;
                selectProvincia.innerHTML = '<option value="">Primero selecciona un departamento</option>';
            }
        });

        // Evento cuando se selecciona una provincia
        selectProvincia.addEventListener('change', function() {
            const departamento = selectDepartamento.value;
            const provincia = this.value;
            
            // Limpiar distrito
            selectDistrito.innerHTML = '<option value="">Seleccionar distrito</option>';
            
            if (departamento && provincia && ubigeoData[departamento] && ubigeoData[departamento][provincia]) {
                const distritos = ubigeoData[departamento][provincia];
                
                distritos.forEach(function(distrito) {
                    const option = document.createElement('option');
                    option.value = distrito;
                    option.textContent = distrito;
                    selectDistrito.appendChild(option);
                });
                
                selectDistrito.disabled = false;
            } else {
                selectDistrito.disabled = true;
            }
        });

        // Restaurar valores si hay formData (en caso de error)
        <% if (locals.formData) { %>
            const formData = <%- JSON.stringify(formData) %>;
            if (formData.departamento) {
                selectDepartamento.value = formData.departamento;
                selectDepartamento.dispatchEvent(new Event('change'));
                
                setTimeout(() => {
                    if (formData.provincia) {
                        selectProvincia.value = formData.provincia;
                        selectProvincia.dispatchEvent(new Event('change'));
                        
                        setTimeout(() => {
                            if (formData.distrito) {
                                selectDistrito.value = formData.distrito;
                            }
                        }, 100);
                    }
                }, 100);
            }
        <% } %>

        // Mensajes predefinidos
        const mensajes = {
            lima: 'Pedido confirmado con pago de delivery S/10. El pago total se realiza al momento de la entrega.',
            provincia: 'Pedido confirmado. Env√≠o tras validaci√≥n del pago correspondiente.',
            cambio: 'Enviar video detallado del calzado para evaluaci√≥n.'
        };

        // Funci√≥n para copiar mensaje al portapapeles
        function copiarMensaje(tipo) {
            const mensaje = mensajes[tipo];
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(mensaje).then(() => {
                    alert(`‚úÖ Mensaje copiado al portapapeles:\n\n"${mensaje}"`);
                }).catch(err => {
                    console.error('Error al copiar:', err);
                    alert('‚ùå Error al copiar el mensaje');
                });
            } else {
                // Fallback para navegadores antiguos
                const textarea = document.createElement('textarea');
                textarea.value = mensaje;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert(`‚úÖ Mensaje copiado:\n\n"${mensaje}"`);
            }
        }

        // Inventario completo desde el servidor
        const inventario = <%- JSON.stringify(inventario || {}) %>;

        const selectModelo = document.getElementById('modelo');
        const selectColor = document.getElementById('color');
        const selectMarca = document.getElementById('marca');
        const selectTaco = document.getElementById('tamano_taco');
        const selectTalla = document.getElementById('talla');
        const tallaInfo = document.getElementById('tallaInfo');

        // Cuando se selecciona un modelo
        selectModelo.addEventListener('change', function() {
            const modeloSeleccionado = this.value;
            
            // Limpiar y resetear campos dependientes
            selectColor.innerHTML = '<option value="">Seleccionar color</option>';
            selectMarca.innerHTML = '<option value="">Seleccionar marca</option>';
            selectTaco.innerHTML = '<option value="">Seleccionar tama√±o de taco</option>';
            selectTalla.innerHTML = '<option value="">Selecciona color, marca y taco primero</option>';
            
            selectColor.disabled = true;
            selectMarca.disabled = true;
            selectTaco.disabled = true;
            selectTalla.disabled = true;
            
            if (modeloSeleccionado && inventario[modeloSeleccionado]) {
                const data = inventario[modeloSeleccionado];
                
                // Poblar colores disponibles
                if (data.colores && data.colores.length > 0) {
                    data.colores.forEach(color => {
                        const option = document.createElement('option');
                        option.value = color;
                        option.textContent = color;
                        selectColor.appendChild(option);
                    });
                    selectColor.disabled = false;
                }
                
                // Poblar marcas disponibles
                if (data.marcas && data.marcas.length > 0) {
                    data.marcas.forEach(marca => {
                        const option = document.createElement('option');
                        option.value = marca;
                        option.textContent = marca;
                        selectMarca.appendChild(option);
                    });
                    selectMarca.disabled = false;
                }
                
                // Poblar tama√±os de taco disponibles
                if (data.tacos && data.tacos.length > 0) {
                    data.tacos.forEach(taco => {
                        const option = document.createElement('option');
                        option.value = taco;
                        option.textContent = taco;
                        selectTaco.appendChild(option);
                    });
                    selectTaco.disabled = false;
                }
            }
        });

        // Cuando cambia color, marca o taco, actualizar tallas
        function actualizarTallas() {
            const modeloSeleccionado = selectModelo.value;
            const colorSeleccionado = selectColor.value;
            const marcaSeleccionada = selectMarca.value;
            const tacoSeleccionado = selectTaco.value;
            
            selectTalla.innerHTML = '<option value="">Seleccionar talla</option>';
            selectTalla.disabled = true;
            
            if (modeloSeleccionado && colorSeleccionado && marcaSeleccionada && tacoSeleccionado && inventario[modeloSeleccionado]) {
                const varianteKey = `${colorSeleccionado}|${marcaSeleccionada}|${tacoSeleccionado}`;
                const data = inventario[modeloSeleccionado];
                
                // Buscar la variante exacta
                const variante = data.variantes.find(v => v.key === varianteKey);
                
                if (variante && variante.tallas) {
                    const tallasDisponibles = Object.keys(variante.tallas).sort();
                    
                    if (tallasDisponibles.length > 0) {
                        tallasDisponibles.forEach(talla => {
                            const stock = variante.tallas[talla];
                            const option = document.createElement('option');
                            option.value = talla;
                            option.textContent = `${talla} (${stock} disponibles)`;
                            selectTalla.appendChild(option);
                        });
                        
                        selectTalla.disabled = false;
                        tallaInfo.textContent = `üëü Tallas disponibles: ${tallasDisponibles.join(', ')}`;
                        tallaInfo.className = 'text-success';
                    } else {
                        tallaInfo.textContent = '‚ö†Ô∏è Esta combinaci√≥n no tiene stock disponible';
                        tallaInfo.className = 'text-danger';
                    }
                } else {
                    tallaInfo.textContent = '‚ö†Ô∏è Esta combinaci√≥n no est√° disponible';
                    tallaInfo.className = 'text-danger';
                }
            } else {
                tallaInfo.textContent = 'Selecciona todos los atributos del producto';
                tallaInfo.className = 'text-muted';
            }
        }

        selectColor.addEventListener('change', actualizarTallas);
        selectMarca.addEventListener('change', actualizarTallas);
        selectTaco.addEventListener('change', actualizarTallas);

        // Validar stock antes de enviar
        document.getElementById('formVenta').addEventListener('submit', function(e) {
            const modelo = selectModelo.value;
            const color = selectColor.value;
            const marca = selectMarca.value;
            const taco = selectTaco.value;
            const talla = parseInt(selectTalla.value);
            const cantidad = parseInt(document.getElementById('cantidad').value);
            
            if (modelo && color && marca && taco && talla && inventario[modelo]) {
                const varianteKey = `${color}|${marca}|${taco}`;
                const data = inventario[modelo];
                const variante = data.variantes.find(v => v.key === varianteKey);
                
                if (variante && variante.tallas) {
                    const stockDisponible = variante.tallas[talla] || 0;
                
                if (cantidad > stockDisponible) {
                    e.preventDefault();
                    alert(`‚ö†Ô∏è Stock insuficiente.\n\nSolicitado: ${cantidad} unidades\nDisponible: ${stockDisponible} unidades`);
                    return false;
                }
            }
        });
    </script>
    <script>
        // Validaci√≥n adicional antes de enviar
        document.getElementById('formVenta').addEventListener('submit', function(e) {
            const deliveryPagado = document.getElementById('deliveryPagado').checked;
            
            if (!deliveryPagado) {
                e.preventDefault();
                alert('‚ö†Ô∏è Debes marcar el delivery como pagado para registrar la venta.');
                return false;
            }
        });
    </script>
</body>
</html>
